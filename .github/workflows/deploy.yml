name: Deploy Task Manager

on:
  push:
    branches: [ main ]

jobs:
  test-components:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Test Frontend Build
      run: |
        echo "Testing frontend build..."
        cd frontend
        npm install
        npm run build
        echo "✅ Frontend build successful!"
    
    - name: Test AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ca-central-1
    
    - name: Test S3 Access
      run: |
        echo "Testing S3 access..."
        aws s3 ls s3://task-manager-frontend-prakshal
        echo "✅ S3 access successful!"
    
    - name: Test EC2 SSH Connection
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "Testing EC2 connection..."
          pwd
          whoami
          echo "✅ EC2 connection successful!"
    
    - name: Deploy Frontend to S3
      run: |
        echo "Deploying frontend to S3..."
        aws s3 sync frontend/build/ s3://task-manager-frontend-prakshal --delete
        echo "✅ Frontend deployed to S3!"
    
    - name: Deploy Backend to EC2
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "Deploying backend to EC2..."
          cd /var/www/task-manager
          echo "Current directory: $(pwd)"
          echo "Pulling latest code..."
          git pull origin main
          echo "Installing dependencies..."
          cd backend
          npm install --production
          echo "Restarting application..."
          pm2 restart task-manager-backend || pm2 start ecosystem.config.js
          echo "✅ Backend deployed to EC2!"